name: sam-opensearch-local

services:
  opensearch:
    image: opensearchproject/opensearch:2.14.0
    container_name: sam-opensearch
    environment:
      - discovery.type=single-node
      - DISABLE_INSTALL_DEMO_CONFIG=true
      - DISABLE_SECURITY_PLUGIN=true
      - bootstrap.memory_lock=true
      - OPENSEARCH_JAVA_OPTS=-Xms512m -Xmx512m
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    ports:
      - "${OPENSEARCH_PORT:-9200}:9200"
      - "${OPENSEARCH_PERF_PORT:-9600}:9600"
    volumes:
      - opensearch-data:/usr/share/opensearch/data
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:9200/_cluster/health > /dev/null || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 30s

  dashboards:
    image: opensearchproject/opensearch-dashboards:2.14.0
    container_name: sam-opensearch-dashboards
    depends_on:
      opensearch:
        condition: service_healthy
    environment:
      OPENSEARCH_HOSTS: '["http://opensearch:9200"]'
      DISABLE_SECURITY_DASHBOARDS_PLUGIN: "true"
    ports:
      - "${OPENSEARCH_DASHBOARDS_PORT:-5601}:5601"

  openapi-ui:
    image: swaggerapi/swagger-ui:v5.17.14
    container_name: sam-opensearch-openapi
    depends_on:
      opensearch:
        condition: service_healthy
    environment:
      SWAGGER_JSON: /opensearch-local.openapi.yaml
    ports:
      - "${OPENSEARCH_OPENAPI_PORT:-8081}:8080"
    volumes:
      - ./openapi/opensearch-local.openapi.yaml:/usr/share/nginx/html/opensearch-local.openapi.yaml:ro

volumes:
  opensearch-data:
